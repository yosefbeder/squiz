// Importing stuff

const forbesList = require('forbes-list');

// Dom Elements
const container = document.querySelector('.app__container');
const btnCheck = document.querySelector('.btn--check');
const btnReSort = document.querySelector('.btn--resort');

// Dragging Elements

// App class
class App {
  constructor() {
    this.init();
  }

  async init() {
    this.data = await this.getData();
    this.curData = this.getRandomSort(this.data);
    this.displayArr(this.curData);
  }

  async getData() {
    const forbes = await require('forbes-list');
    const forbesList = await forbes.list({ limit: 10 });
    return forbesList;
  }

  displayArr(arr) {
    // clearing container
    container.innerHTML = '';

    //displaying elements
    arr.forEach((data, i) => {
      this.displayEl(data, i + 1);
    });

    // Adding dragging event
    const personDesc = document.querySelectorAll('.person__desc');
    personDesc.forEach((desc, i) => {
      desc.addEventListener('dragstart', function (e) {
        desc.classList.add('dragging');
        console.log(e);
        e.dataTransfer.setData('text/plain', i + '');
      });
      desc.addEventListener('dragend', function () {
        desc.classList.remove('dragging');
      });
      desc.addEventListener('dragover', function (e) {
        e.preventDefault();
        desc.classList.add('draggingover');
      });
      desc.addEventListener('dragleave', function () {
        desc.classList.remove('draggingover');
      });
      desc.addEventListener('drop', e => {
        e.preventDefault();
        desc.classList.remove('draggingover');
        const dragStartingIndex = e.dataTransfer.getData('text/plain');
        this.replace(this.curData, i, dragStartingIndex);
      });
    });
  }

  displayEl(data, id) {
    const { personName: name, state, birthDate, thumbnail: imgPath } = data;
    const age = (() =>
      new Date().getFullYear() - new Date(birthDate).getFullYear())();
    const html = `
          <div class="person">
            <div class="person__rank person__rank--${
              id <= 3 ? id : 'solid'
            }">${id}</div>
            <div class="person__desc" draggable="true">
              <div class="person__info">
                <div class="person__header">Name</div>
                <div class="person__text">${name}</div>
              </div>
              <div class="person__info">
                <div class="person__header">State</div>
                <div class="person__text">${state || 'unkown'}</div>
              </div>
              <div class="person__info">
                <div class="person__header">Age</div>
                <div class="person__text">${age}</div>
              </div>
            </div>
            <img
              src="${imgPath}"
              alt=""
              srcset=""
              class="person__img"
            />
          </div>
    `;

    container.insertAdjacentHTML('beforeend', html);
  }

  getRandomSort(arr) {
    return arr.sort(() => 0.5 - Math.random());
  }

  replace(arr, i1, i2) {
    arr[i1] = arr[i2];
  }
}

const app = new App();
